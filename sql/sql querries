/* Main page query to count number of tuples 
Should = 9937889 */
SELECT (covid_cases_count + economies_count + government_responses_count + populations_count + mobility_count + public_health_count + regions_count + vaccinations_count + races_count) as total_count
FROM
    (SELECT COUNT(*) as covid_cases_count
    FROM "MARINA.TUCKER".covid_cases),
    (SELECT COUNT(*) as economies_count
    FROM "MARINA.TUCKER".economies),
    (SELECT COUNT(*) as government_responses_count
    FROM "MARINA.TUCKER".government_responses),
    (SELECT COUNT(*) as populations_count
    FROM "MARINA.TUCKER".populations),
    (SELECT COUNT(*) as mobility_count
    FROM "MARINA.TUCKER".mobility),
    (SELECT COUNT(*) as public_health_count
    FROM "MARINA.TUCKER".public_health),
    (SELECT COUNT(*) as regions_count
    FROM "MARINA.TUCKER".regions),
    (SELECT COUNT(*) as vaccinations_count
    FROM "MARINA.TUCKER".vaccinations),
    (SELECT COUNT(*) as races_count
    FROM races)
;
/*SAMPLE OF REWRITTEN QUERY 1 WITH TEST*/

SELECT v_date, (vaccination_rate/case_rate) as vaccine_correlation_factor
FROM
    (SELECT v_date, AVG(new_vaccine_doses_administered/population) as vaccination_rate
    FROM "MARINA.TUCKER".populations,
        (SELECT region_id as vacc_region_id, v_date, new_vaccine_doses_administered
        FROM "MARINA.TUCKER".vaccinations),
        (SELECT id, location
        FROM "MARINA.TUCKER".regions
        /*WHERE location = user_country_input*/)
    WHERE vacc_region_id = id
    /*AND location = user_country_input*/
    AND population > 0
    GROUP BY v_date),
    (SELECT cc_date, AVG(new_confirmed/population) as case_rate
    FROM "MARINA.TUCKER".populations,
        (SELECT region_id as covid_region_id, cc_date, new_confirmed
        FROM "MARINA.TUCKER".covid_cases),
        (SELECT id, location
        FROM "MARINA.TUCKER".regions
        /*WHERE location = user_country_input*/)
    WHERE covid_region_id = id
    /*AND location = user_country_input*/
    AND population > 0
    GROUP BY cc_date)
WHERE v_date = cc_date;
 /*TEST*/
SELECT v_date, (vaccination_rate/case_rate) as vaccine_correlation_factor
FROM
    (SELECT v_date, AVG(new_vaccine_doses_administered/population) as vaccination_rate
    FROM "MARINA.TUCKER".populations,
        (SELECT region_id as vacc_region_id, v_date, new_vaccine_doses_administered
        FROM "MARINA.TUCKER".vaccinations),
        (SELECT id, location
        FROM "MARINA.TUCKER".regions
        WHERE location = 'Austria')
    WHERE vacc_region_id = id
    AND location = 'Austria'
    AND population > 0
    GROUP BY v_date),
    (SELECT cc_date, AVG(new_confirmed/population) as case_rate
    FROM "MARINA.TUCKER".populations,
        (SELECT region_id as covid_region_id, cc_date, new_confirmed
        FROM "MARINA.TUCKER".covid_cases),
        (SELECT id, location
        FROM "MARINA.TUCKER".regions
        WHERE location = 'Austria')
    WHERE covid_region_id = id
    AND location = 'Austria'
    AND population > 0
    GROUP BY cc_date)
WHERE v_date = cc_date;


/*QUERIES BY COUNTRY*/
/* 
1. Monitor the covid vaccine distribution over time, how have the vaccination rates 
correlated with changes in case rates? 
*/
SELECT v_date, AVG(new_vaccine_doses_administered/population) as vaccination_rate
FROM "MARINA.TUCKER".populations,
    (SELECT region_id as vacc_region_id, v_date, new_vaccine_doses_administered
    FROM "MARINA.TUCKER".vaccinations),
    (SELECT id, location
    FROM "MARINA.TUCKER".regions
    /*WHERE location = user_country_input*/)
WHERE vacc_region_id = id
/*AND location = user_country_input*/
AND population > 0
GROUP BY v_date;

SELECT cc_date, AVG(new_confirmed/population) as case_rate
FROM "MARINA.TUCKER".populations,
    (SELECT region_id as covid_region_id, cc_date, new_confirmed
    FROM "MARINA.TUCKER".covid_cases),
    (SELECT id, location
    FROM "MARINA.TUCKER".regions
    /*WHERE location = user_country_input*/)
WHERE covid_region_id = id
/*AND location = user_country_input*/
AND population > 0
GROUP BY c_date;

/* 
3. Compare and rank different countries or regions based on their pandemic response effectiveness over time, 
considering factors such as testing rates, vaccination campaigns, and healthcare system resilience. 
*/

SELECT gr_date, AVG(stringency_index)
FROM "MARINA.TUCKER".populations,
    (SELECT region_id as gr_region_id, stringency_index, gr_date
    FROM "MARINA.TUCKER".government_responses
    /*WHERE region_id = user_region_input*/),
    (SELECT id, location
    FROM "MARINA.TUCKER".regions
    /*WHERE location = user_country_input*/)
WHERE gr_region_id = id
/*AND location = user_country_input*/
AND population > 0
GROUP BY gr_date;

SELECT cc_date, AVG(new_confirmed/population) as case_rate
FROM "MARINA.TUCKER".populations,
    (SELECT region_id as covid_region_id, cc_date, new_confirmed
    FROM "MARINA.TUCKER".covid_cases),
    (SELECT id, location
    FROM "MARINA.TUCKER".regions
    /*WHERE location = user_country_input*/)
WHERE covid_region_id = id
/*AND location = user_country_input*/
AND population > 0
GROUP BY c_date;

/*
5.1 Analyze longitudinal covid cases based on age 
to find vulnerable populations and figure out measures to help change the vulnerability over time. 
*/

SELECT age_case_month, num_age_cases/total_num_cases as case_rate
FROM
    (SELECT case_month as age_case_month, COUNT(caseid) as num_age_cases
    FROM races
    /*WHERE res_state = user_state_selection*/
    /*AND age_group = user_age_selection*/
    GROUP BY case_month
    ORDER BY case_month asc),
    (SELECT case_month as total_case_month, COUNT(caseid) as total_num_cases
    FROM races
    /*WHERE res_state = user_state_selection*/
    GROUP BY case_month
    ORDER BY case_month asc)
WHERE age_case_month = total_case_month;

/* 
5.2 Analyze longitudinal covid cases in the United States based on race, sex, and ethnicity
to find vulnerable populations and figure out measures to help change the vulnerability over time. 
*/

SELECT race_case_month, num_race_cases/total_num_cases as case_rate
FROM
    (SELECT case_month as race_case_month, COUNT(caseid) as num_race_cases
    FROM races
    /*WHERE res_state = user_state_selection*/
    /*AND race = user_race_selection*/
    GROUP BY case_month
    ORDER BY case_month asc),
    (SELECT case_month as total_case_month, COUNT(caseid) as total_num_cases
    FROM races
    /*WHERE res_state = user_state_selection*/
    GROUP BY case_month
    ORDER BY case_month asc)
WHERE race_case_month = total_case_month;

/* 
7. Study the relationship between community mobility patterns (visiting grocery stores, pharmacies, parks, retail/recreational)
and the emergence of localized COVID-19 outbreaks over time, identifying potential superspreader events. 
*/
SELECT mp_date, /*user_mobility_input*/
FROM "MARINA.TUCKER".populations,
    (SELECT region_id as mp_region_id, /*user_mobility_input*/, mp_date
    FROM "MARINA.TUCKER".mobility),
    (SELECT id, location
    FROM "MARINA.TUCKER".regions
    /*WHERE location = user_country_input*/)
WHERE mp_region_id = id
/*AND location = user_country_input*/
AND population > 0
GROUP BY mp_date;

SELECT cc_date, AVG(new_confirmed/population) as case_rate
FROM "MARINA.TUCKER".populations,
    (SELECT region_id as covid_region_id, cc_date, new_confirmed
    FROM "MARINA.TUCKER".covid_cases),
    (SELECT id, location
    FROM "MARINA.TUCKER".regions
    /*WHERE location = user_country_input*/)
WHERE covid_region_id = id
/*AND location = user_country_input*/
AND population > 0
GROUP BY c_date;

/*TESTS*/
/*1*/
SELECT v_date, AVG(new_vaccine_doses_administered/population) as vaccination_rate
FROM "MARINA.TUCKER".populations,
    (SELECT region_id as vacc_region_id, v_date, new_vaccine_doses_administered
    FROM "MARINA.TUCKER".vaccinations),
    (SELECT id, location
    FROM "MARINA.TUCKER".regions
    WHERE location = 'Austria')
WHERE vacc_region_id = id
AND location = 'Austria'
AND population > 0
GROUP BY v_date;

SELECT cc_date, AVG(new_confirmed/population) as case_rate
FROM "MARINA.TUCKER".populations,
    (SELECT region_id as covid_region_id, cc_date, new_confirmed
    FROM "MARINA.TUCKER".covid_cases),
    (SELECT id, location
    FROM "MARINA.TUCKER".regions
    WHERE location = 'Austria')
WHERE covid_region_id = id
AND location = 'Austria'
AND population > 0
GROUP BY cc_date;

/*3*/
SELECT gr_date, AVG(stringency_index)
FROM "MARINA.TUCKER".populations,
    (SELECT region_id as gr_region_id, stringency_index, gr_date
    FROM "MARINA.TUCKER".government_responses),
    (SELECT id, location
    FROM "MARINA.TUCKER".regions
    WHERE location = 'Austria')
WHERE gr_region_id = id
AND location = 'Austria'
AND population > 0
GROUP BY gr_date;

/*5.1*/
SELECT age_case_month, num_age_cases/total_num_cases as case_rate
FROM
    (SELECT case_month as age_case_month, COUNT(caseid) as num_age_cases
    FROM races
    WHERE res_state = 'NC'
    AND age_group = '65+ years'
    GROUP BY case_month
    ORDER BY case_month asc),
    (SELECT case_month as total_case_month, COUNT(caseid) as total_num_cases
    FROM races
    WHERE res_state = 'NC'
    GROUP BY case_month
    ORDER BY case_month asc)
WHERE age_case_month = total_case_month;

/*5.2*/
SELECT race_case_month, num_race_cases/total_num_cases as case_rate
FROM
    (SELECT case_month as race_case_month, COUNT(caseid) as num_race_cases
    FROM races
    WHERE res_state = 'NC'
    AND race = 'White'
    GROUP BY case_month
    ORDER BY case_month asc),
    (SELECT case_month as total_case_month, COUNT(caseid) as total_num_cases
    FROM races
    WHERE res_state = 'NC'
    GROUP BY case_month
    ORDER BY case_month asc)
WHERE race_case_month = total_case_month;

/*7*/
SELECT mp_date, AVG(grocery_pharmacy)
FROM "MARINA.TUCKER".populations,
    (SELECT region_id as mp_region_id, grocery_pharmacy, mp_date
    FROM "MARINA.TUCKER".mobility),
    (SELECT id, location
    FROM "MARINA.TUCKER".regions
    WHERE location = 'Australia')
WHERE mp_region_id = id
AND location = 'Australia'
GROUP BY mp_date;
   
